<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Bridge Session Token Test - Recently Viewed Products Pro</title>
    <script src="https://unpkg.com/@shopify/app-bridge@3.7.9/dist/index.global.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: #f6f6f7;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #004c3f;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #e1e3e5;
        border-radius: 6px;
        background: #fafbfc;
      }
      .test-section h3 {
        margin-top: 0;
        color: #2c3e50;
      }
      button {
        background: #008060;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #006b52;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.ready {
        background: #d4edda;
        color: #155724;
      }
      .status.not-ready {
        background: #f8d7da;
        color: #721c24;
      }
      .status.loading {
        background: #d1ecf1;
        color: #0c5460;
      }
      .instructions {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }
      .instructions h4 {
        margin-top: 0;
        color: #0066cc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê App Bridge Session Token Test</h1>
      <p style="text-align: center; color: #666">
        Recently Viewed Products Pro - App Bridge Integration Testing
      </p>

      <div class="instructions">
        <h4>üìã Test Talimatlarƒ±:</h4>
        <ol>
          <li>
            <strong
              >Bu sayfayƒ± Shopify development store admin panelinde a√ßƒ±n</strong
            >
          </li>
          <li><strong>App Bridge otomatik olarak initialize olacak</strong></li>
          <li><strong>"Test App Bridge" butonuna tƒ±klayƒ±n</strong></li>
          <li><strong>Session token'larƒ± test edin</strong></li>
        </ol>
        <p>
          <strong>‚ö†Ô∏è √ñnemli:</strong> Bu sayfa sadece Shopify admin panelinde
          √ßalƒ±≈üƒ±r!
        </p>
      </div>

      <div class="status" id="bridgeStatus">üîÑ Loading App Bridge...</div>

      <div class="test-section">
        <h3>üöÄ App Bridge Initialization</h3>
        <p>Test App Bridge initialization and session token generation.</p>
        <button onclick="testAppBridge()" id="testBtn" disabled>
          Test App Bridge
        </button>
        <button onclick="getBridgeStatus()">Get Bridge Status</button>
        <div id="bridgeResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üé´ Session Token Operations</h3>
        <p>Test session token operations using App Bridge.</p>
        <button onclick="testSessionToken()" id="sessionBtn" disabled>
          Test Session Token
        </button>
        <button onclick="testAuthenticatedRequest()" id="authBtn" disabled>
          Test Authenticated Request
        </button>
        <button onclick="refreshSession()" id="refreshBtn" disabled>
          Refresh Session
        </button>
        <div id="sessionResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üìä Test Results Summary</h3>
        <p>Overall test status and recommendations.</p>
        <button onclick="runAllTests()" id="allTestsBtn" disabled>
          Run All Tests
        </button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="summaryResult" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      // Global variables
      let appBridge = null
      let testResults = {}
      let isBridgeReady = false

      // Initialize App Bridge when page loads
      document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ App Bridge Test Page Loaded')
        initializeAppBridge()
      })

      // Initialize Shopify App Bridge
      async function initializeAppBridge() {
        try {
          updateBridgeStatus('loading', 'üîÑ Initializing App Bridge...')

          // Check if we're in Shopify admin context
          if (typeof window.Shopify === 'undefined') {
            updateBridgeStatus(
              'not-ready',
              '‚ùå Not in Shopify admin context. Please open this page in your Shopify development store admin panel.'
            )
            showResult(
              'bridgeResult',
              '‚ùå This page must be opened in Shopify admin panel to work properly.\n\nPlease:\n1. Go to your development store\n2. Install the Recently Viewed Products Pro app\n3. Open this test page from within the app',
              'error'
            )
            return
          }

          // Get Shopify context
          const urlParams = new URLSearchParams(window.location.search)
          const host = urlParams.get('host')
          const shop = window.Shopify?.shop || 'unknown'

          console.log('üîç Shopify Context:', { host, shop })

          if (!host) {
            updateBridgeStatus(
              'not-ready',
              '‚ùå Missing host parameter. Please access this page through the Shopify app.'
            )
            showResult(
              'bridgeResult',
              "‚ùå Missing host parameter.\n\nThis usually means you're not accessing the page through the Shopify app.\nPlease install and open the app first.",
              'error'
            )
            return
          }

          // Initialize App Bridge
          appBridge = window.createApp({
            apiKey: 'your-api-key', // This will be replaced by Shopify
            host: host,
            forceRedirect: false,
          })

          console.log('‚úÖ App Bridge initialized:', appBridge)
          isBridgeReady = true
          updateBridgeStatus(
            'ready',
            'üü¢ App Bridge Ready! Session tokens available.'
          )

          // Enable test buttons
          document.getElementById('testBtn').disabled = false
          document.getElementById('sessionBtn').disabled = false
          document.getElementById('authBtn').disabled = false
          document.getElementById('refreshBtn').disabled = false
          document.getElementById('allTestsBtn').disabled = false

          showResult(
            'bridgeResult',
            '‚úÖ App Bridge initialized successfully!\n\nContext:\n- Host: ' +
              host +
              '\n- Shop: ' +
              shop +
              '\n- App Bridge: Ready\n\nSession token testing is now available!',
            'success'
          )
        } catch (error) {
          console.error('‚ùå App Bridge initialization failed:', error)
          updateBridgeStatus('not-ready', '‚ùå App Bridge initialization failed')
          showResult(
            'bridgeResult',
            '‚ùå App Bridge initialization failed:\n\n' +
              error.message +
              '\n\nPlease check the console for more details.',
            'error'
          )
        }
      }

      // Update bridge status
      function updateBridgeStatus(status, message) {
        const statusElement = document.getElementById('bridgeStatus')
        statusElement.textContent = message
        statusElement.className = `status ${status}`
      }

      // Show result
      function showResult(elementId, content, type = 'info') {
        const element = document.getElementById(elementId)
        element.style.display = 'block'
        element.className = `result ${type}`
        element.textContent = content
      }

      // Test App Bridge
      async function testAppBridge() {
        if (!appBridge) {
          showResult(
            'bridgeResult',
            '‚ùå App Bridge not initialized. Please wait for initialization to complete.',
            'error'
          )
          return
        }

        try {
          showResult(
            'bridgeResult',
            'üß™ Testing App Bridge functionality...',
            'info'
          )

          // Test basic App Bridge functionality
          const appState = appBridge.getState()
          console.log('üìä App Bridge State:', appState)

          // Test session token generation
          const sessionToken = await getSessionToken()

          if (sessionToken) {
            showResult(
              'bridgeResult',
              '‚úÖ App Bridge test successful!\n\nSession Token Generated:\n' +
                JSON.stringify(sessionToken, null, 2),
              'success'
            )
            testResults.appBridge = 'PASS'
          } else {
            showResult(
              'bridgeResult',
              '‚ö†Ô∏è App Bridge initialized but session token generation failed.\n\nThis might be normal for the first request.',
              'warning'
            )
            testResults.appBridge = 'PARTIAL'
          }
        } catch (error) {
          console.error('‚ùå App Bridge test failed:', error)
          showResult(
            'bridgeResult',
            '‚ùå App Bridge test failed:\n\n' + error.message,
            'error'
          )
          testResults.appBridge = 'FAIL'
        }
      }

      // Get session token using App Bridge
      async function getSessionToken() {
        try {
          if (!appBridge) {
            throw new Error('App Bridge not initialized')
          }

          // Use App Bridge's authenticatedFetch
          const response = await appBridge.authenticatedFetch(
            '/api/session/info'
          )

          if (response.ok) {
            const data = await response.json()
            console.log('‚úÖ Session token retrieved via App Bridge:', data)
            return data
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }
        } catch (error) {
          console.error('‚ùå Session token retrieval failed:', error)
          return null
        }
      }

      // Test session token
      async function testSessionToken() {
        try {
          showResult('sessionResult', 'üß™ Testing session token...', 'info')

          const sessionToken = await getSessionToken()

          if (sessionToken) {
            showResult(
              'sessionResult',
              '‚úÖ Session token test successful!\n\nToken Data:\n' +
                JSON.stringify(sessionToken, null, 2),
              'success'
            )
            testResults.sessionToken = 'PASS'
          } else {
            showResult(
              'sessionResult',
              '‚ùå Session token test failed.\n\nNo session token received.',
              'error'
            )
            testResults.sessionToken = 'FAIL'
          }
        } catch (error) {
          console.error('‚ùå Session token test failed:', error)
          showResult(
            'sessionResult',
            '‚ùå Session token test failed:\n\n' + error.message,
            'error'
          )
          testResults.sessionToken = 'FAIL'
        }
      }

      // Test authenticated request
      async function testAuthenticatedRequest() {
        try {
          showResult(
            'sessionResult',
            'üß™ Testing authenticated request...',
            'info'
          )

          if (!appBridge) {
            throw new Error('App Bridge not initialized')
          }

          const response = await appBridge.authenticatedFetch(
            '/api/session/validate'
          )

          if (response.ok) {
            const data = await response.json()
            showResult(
              'sessionResult',
              '‚úÖ Authenticated request test successful!\n\nResponse:\n' +
                JSON.stringify(data, null, 2),
              'success'
            )
            testResults.authenticatedRequest = 'PASS'
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }
        } catch (error) {
          console.error('‚ùå Authenticated request test failed:', error)
          showResult(
            'sessionResult',
            '‚ùå Authenticated request test failed:\n\n' + error.message,
            'error'
          )
          testResults.authenticatedRequest = 'FAIL'
        }
      }

      // Refresh session
      async function refreshSession() {
        try {
          showResult('sessionResult', 'üîÑ Refreshing session...', 'info')

          if (!appBridge) {
            throw new Error('App Bridge not initialized')
          }

          const response = await appBridge.authenticatedFetch(
            '/api/session/refresh',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                shop: window.Shopify?.shop || 'unknown',
                user: 'current',
              }),
            }
          )

          if (response.ok) {
            const data = await response.json()
            showResult(
              'sessionResult',
              '‚úÖ Session refresh successful!\n\nNew Session Data:\n' +
                JSON.stringify(data, null, 2),
              'success'
            )
            testResults.sessionRefresh = 'PASS'
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }
        } catch (error) {
          console.error('‚ùå Session refresh failed:', error)
          showResult(
            'sessionResult',
            '‚ùå Session refresh failed:\n\n' + error.message,
            'error'
          )
          testResults.sessionRefresh = 'FAIL'
        }
      }

      // Get bridge status
      function getBridgeStatus() {
        if (!appBridge) {
          showResult('bridgeResult', '‚ùå App Bridge not initialized', 'error')
          return
        }

        const status = {
          isInitialized: !!appBridge,
          hasApp: !!appBridge,
          bridgeState: appBridge.getState(),
          timestamp: new Date().toISOString(),
        }

        showResult(
          'bridgeResult',
          'üìä Bridge Status:\n\n' + JSON.stringify(status, null, 2),
          'info'
        )
      }

      // Run all tests
      async function runAllTests() {
        testResults = {}

        showResult(
          'summaryResult',
          'üöÄ Running all App Bridge tests...\n\n',
          'info'
        )

        // Run tests sequentially
        await testAppBridge()
        await new Promise((resolve) => setTimeout(resolve, 1000))

        await testSessionToken()
        await new Promise((resolve) => setTimeout(resolve, 1000))

        await testAuthenticatedRequest()
        await new Promise((resolve) => setTimeout(resolve, 1000))

        await refreshSession()
        await new Promise((resolve) => setTimeout(resolve, 1000))

        // Generate summary
        const summary = generateTestSummary()
        showResult('summaryResult', summary, 'info')
      }

      // Generate test summary
      function generateTestSummary() {
        const totalTests = Object.keys(testResults).length
        const passedTests = Object.values(testResults).filter(
          (result) => result === 'PASS'
        ).length
        const partialTests = Object.values(testResults).filter(
          (result) => result === 'PARTIAL'
        ).length
        const failedTests = totalTests - passedTests - partialTests

        let summary = `üìä App Bridge Test Results Summary\n`
        summary += `================================\n\n`

        Object.entries(testResults).forEach(([test, result]) => {
          let emoji = '‚ùå'
          if (result === 'PASS') emoji = '‚úÖ'
          else if (result === 'PARTIAL') emoji = '‚ö†Ô∏è'

          summary += `${emoji} ${test}: ${result}\n`
        })

        summary += `\n================================\n`
        summary += `Total Tests: ${totalTests}\n`
        summary += `Passed: ${passedTests}\n`
        summary += `Partial: ${partialTests}\n`
        summary += `Failed: ${failedTests}\n`
        summary += `Success Rate: ${
          totalTests > 0
            ? Math.round(
                ((passedTests + partialTests * 0.5) / totalTests) * 100
              )
            : 0
        }%\n\n`

        if (failedTests === 0 && passedTests > 0) {
          summary += `üéâ App Bridge tests successful! Session tokens are working correctly.\n`
          summary += `This should resolve the "Using session tokens for user authentication" requirement.\n`
        } else if (partialTests > 0) {
          summary += `‚ö†Ô∏è Some tests partially passed. This might be normal for initial setup.\n`
          summary += `Try refreshing the page and running tests again.\n`
        } else {
          summary += `‚ùå Several tests failed. Please check the individual test results above.\n`
          summary += `Make sure you\'re in Shopify admin context.\n`
        }

        return summary
      }

      // Clear results
      function clearResults() {
        const resultElements = [
          'bridgeResult',
          'sessionResult',
          'summaryResult',
        ]
        resultElements.forEach((id) => {
          const element = document.getElementById(id)
          element.style.display = 'none'
        })
        testResults = {}
      }
    </script>
  </body>
</html>
